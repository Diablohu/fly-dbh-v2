---
import { ClientRouter } from "astro:transitions";

import { gtag as gtagId, gtm as gtmId } from "@/constants/google-analytics";

import LogoSVG from "@/assets/logo.svg";
import Block from "@/components/block.astro";
import BannerAndHeader from "./_components/banner-and-header";
import Navbar from "./_components/navbar.astro";
import Announcements from "./_components/announcements.astro";
import PrepareHistory from "./_components/prepare-history";

import { title as siteTitle, slogan } from "@/global";

import { themeColorLight, themeColorDark } from "@/global";
import "@/global.less";

// ============================================================================

interface Props {
    /**
     * 网页标题
     * - 默认为兜底文字
     */
    title?: string;
    /**
     * 头部 Meta 信息 `keyword`
     * - 默认为兜底文字
     */
    keywords?: string;
    /**
     * 头部 Meta 信息 `description`
     * - 默认无内容
     */
    description?: string;

    /**
     * 是否显示顶部导航条
     * - 默认隐藏
     */
    showHeader?: boolean;

    /**
     * 是否显示 Banner
     * - 默认隐藏
     */
    showBanner?: boolean;

    /**
     * 是否显示全局页底
     * - 默认隐藏
     */
    showFooter?: boolean;
}

// ============================================================================
//
// 多语言 & 语言包
//
// ============================================================================

// const _ = Astro.locals.global;
// const currentLocale = Astro.currentLocale || "";
// const { gtag: gtagId, gtm: gtmId } = getGoogleAnalyticsIds(
//     Astro.currentLocale as LocaleType
// );
// console.log(Astro.locals.global);

// ============================================================================

const {
    title = siteTitle,
    keywords = "fly-simming, fly-sim, 飞行模拟, 飞行模拟器, 模拟飞行, 模拟飞行教程, 飞行模拟器教程, 飞行模拟器插件, 飞行模拟器飞机, 飞行模拟器机场, 飞行模拟器教学",
    description = slogan,
    showHeader = false,
    showBanner = false,
    showFooter = false,
} = Astro.props;
---

<!doctype html>
<html lang={Astro.currentLocale}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <meta name="color-scheme" content="dark light" />
        <meta
            name="theme-color"
            content={themeColorLight}
            media="(prefers-color-scheme: light)"
        />
        <meta
            name="theme-color"
            content={themeColorDark}
            media="(prefers-color-scheme: dark)"
        />

        <title>
            {title === "FLY-DBH.com" ? title : `${title} | FLY-DBH.com`}
        </title>

        <!-- Google Tag Manager -->
        {gtmId && (
            <script is:inline define:vars={{ gtmId }}>
                (function (w, d, s, l, i) {
                    w[l] = w[l] || [];
                    w[l].push({
                        "gtm.start": new Date().getTime(),
                        event: "gtm.js",
                    });
                    var f = d.getElementsByTagName(s)[0],
                        j = d.createElement(s),
                        dl = l != "dataLayer" ? "&l=" + l : "";
                    j.async = true;
                    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
                    f.parentNode.insertBefore(j, f);
                })(window, document, "script", "dataLayer", gtmId);
            </script>
        )}
        <!-- End Google Tag Manager -->

        <base target="_self" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        {description && <meta name="description" content={description} />}
        {keywords && <meta name="keywords" content={keywords} />}
        <meta name="generator" content={Astro.generator} />

        <style
            is:inline
            set:html={`
:root {
    --light-theme-color: ${themeColorLight};
    --light-theme-color-p-20: ${themeColorLight}33;
    --light-theme-color-p-50: ${themeColorLight}80;
    --light-theme-color-p-80: ${themeColorLight}cc;
    --dark-theme-color: ${themeColorDark};
    --dark-theme-color-p-20: ${themeColorDark}33;
    --dark-theme-color-p-50: ${themeColorDark}80;
    --dark-theme-color-p-80: ${themeColorDark}cc;
}
`}
        ></style>

        <ClientRouter />
    </head>
    <body>
        <!-- Google Tag Manager (noscript) -->
        {gtmId && (
            <noscript>
                <iframe
                    src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
                    height="0"
                    width="0"
                    style="display:none;visibility:hidden"></iframe>
            </noscript>
        )}
        <!-- End Google Tag Manager (noscript) -->
        <script
            is:inline
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${gtagId}`}
        ></script>
        <script is:inline define:vars={{ gtagId }}>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", gtagId);
        </script>

        <div class="root">
            <BannerAndHeader
                client:idle
                showBanner={showBanner}
                showHeader={showHeader}
                originPathname={Astro.originPathname}
            >
                <LogoSVG slot="logo" />
            </BannerAndHeader>

            <Announcements showHeader={showHeader} />

            <main><slot /></main>

            {
                showFooter && (
                    <Block tag="footer" class="footer">
                        FOOTER
                        {import.meta.env.DEV ? (
                            <Fragment>
                                <hr />
                                <dl>
                                    <dt>Stage 1</dt>
                                    <dd>
                                        favicon
                                        <br />
                                        ?v=
                                        <br />
                                        /videos
                                        <br />
                                        /videos/:tag
                                        <br />
                                        v2.fly-dbh.com preview
                                        <br />
                                        cache strategy
                                        <br />
                                        PWA
                                    </dd>
                                </dl>
                                <dl>
                                    <dt>Stage 2</dt>
                                    <dd>
                                        /sanity-images persist cache
                                        <br />
                                        ?s=
                                    </dd>
                                </dl>
                                <dl>
                                    <dt>Stage 3</dt>
                                    <dd>
                                        /streams
                                        <br />
                                        /streams/challenges
                                        <br />
                                        /streams/flightseeing
                                        <br />
                                        other stream types
                                        <br />
                                        /activities
                                    </dd>
                                </dl>
                                <dl>
                                    <dt>Stage 4</dt>
                                    <dd>
                                        /streams/clips
                                        <br />
                                        /shots
                                    </dd>
                                </dl>
                            </Fragment>
                        ) : null}
                    </Block>
                )
            }

            <Navbar
                showHeader={showHeader}
                originPathname={Astro.originPathname}
            />

            <PrepareHistory client:only />

            <!-- 
            TODO: /?s=[query]
            -->
        </div>
    </body>
</html>

<style lang="less">
    @import "./layout.module.less";
</style>

<script is:inline>
    document.documentElement.setAttribute("javascript-enabled", "");

    if (globalThis.window) {
        // 站外链接兜底为新窗口打开
        document.body.addEventListener("click", (evt) => {
            if (
                evt.target instanceof HTMLElement &&
                evt.target.tagName === "A" &&
                !evt.target.getAttribute("target")
            ) {
                const href = evt.target.getAttribute("href");
                if (href[0] === "/") return;
                if (href[0] === "#") return;
                if (/^(javascript|mailto|tel):/.test(href)) return;
                if (new RegExp(`^${location.origin}`).test(href)) return;
                evt.preventDefault();
                window.open(href, "_blank");
            }
        });
    }
</script>
